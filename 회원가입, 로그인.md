# ğŸ“šÂ 3. íšŒì›ê°€ì…, ë¡œê·¸ì¸

# ğŸ“šÂ 1. íšŒì›ê°€ì…

**âœ”ï¸Â User**

```
User
- email
- password
- Authority authority(ROLE_USER, ROLE_ADMIN)
```

&nbsp;

**âœ”ï¸Â UserRestController**

```
UserRestController - signup
- userService.signup(userSignupRequestDto)
   - userSignupRequestDtoì—ëŠ” email, passwordë§Œ ë“¤ì–´ê°€ ìˆë‹¤.
```

&nbsp;


*`UserSignupRequestDto`*

```java
@Slf4j
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class UserSignupRequestDto {

		private String email;
    private String password;
    private int auth; // 0ì´ë¼ë©´ : admin, 1ì´ë¼ë©´ : user

}
```


&nbsp;

**âœ”ï¸Â UserService**

```java
		@Transactional
    public UserResponseDto signup(UserSignupRequestDto userSignupRequestDto){
        if(userRepository.existsByEmail(userSignupRequestDto.getEmail())){
            throw new RuntimeException("ì´ë¯¸ ê°€ì…ë˜ì–´ ìˆëŠ” ìœ ì €ì…ë‹ˆë‹¤.");
        }

        // íšŒì›ê°€ì…ì‹œí‚¤ê¸° ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸ë¡œ ë°”ê¿”ì„œ ì €ì¥í•œë‹¤.
        User user = userSignupRequestDto.toUser(passwordEncoder);
        return UserResponseDto.of(userRepository.save(user));
    }
```

```java
@Repository
public interface UserRepositoryextendsJpaRepository<User,Long> {

	//í˜„ì¬ ê°€ì…ëœ emailì¸ì§€ í™•ì¸
	boolean existsByEmail(Stringemail);
}
```

- ì´ë¯¸ ê°€ì…ëœ ìœ ì €ì¸ì§€ `email`ì„ í†µí•´ í™•ì¸í•œë‹¤.
- `existByEmail` Repository


&nbsp;

```java
    User user = userSignupRequestDto.toUser(passwordEncoder);

		// userSignupRequestDtoì— ì¶”ê°€
    // PasswordEncoderë¥¼ ì´ìš©í•˜ì—¬ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ëŠ” ë°©ë²•
    // ex) 'password' ë¼ëŠ” í‰ë¬¸ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ $2a$10$kZ.aZODm7JAR7AHkuGlIr.6/6cAzZAN//kVrOy1aTsdkkP4kehoA.
    // ì™€ ê°™ì€ ì•”í˜¸ë¡œ ë°”ê¿”ì„œ ì„œë²„ì— ì €ì¥í•˜ëŠ” ì‘ì—…
		public User toUser(PasswordEncoder passwordEncoder){
        log.info("password : " + passwordEncoder);
        Authority authRes;
        if(auth == 1) authRes = Authority.ROLE_USER; // ì‚¬ìš©ì
        else authRes = Authority.ROLE_ADMIN; // ê´€ë¦¬ì

        return User.builder()
                .email(email)
                .password(passwordEncoder.encode(password)) // ì…ë ¥ëœ ë¹„
                .authority(authRes)
                .build(); // íšŒì›ê°€ì…ëœ ì‚¬ìš©ì
    }
```

- `passwordEncoder.encode(password)` : 'password' ë¼ëŠ” í‰ë¬¸ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ $2a$10$kZ.aZODm7JAR7AHkuGlIr.6/6cAzZAN//kVrOy1aTsdkkP4kehoA. ì™€ ê°™ì€ ì•”í˜¸ë¡œ ë°”ê¿”ì„œ ì„œë²„ì— ì €ì¥í•˜ëŠ” ì‘ì—…

&nbsp;

<img width="884" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-12-24 á„‹á…©á„’á…® 6 52 55" src="https://user-images.githubusercontent.com/72541544/209440118-3033a9bd-851d-4983-ab2f-f390b00602b1.png">


ì™€ ê°™ì´ ì €ì¥ëœë‹¤.


&nbsp;

```java
return UserResponseDto.of(userRepository.save(user));
```

- save : JPA Repositoryì˜ ë©”ì„œë“œ êµ¬í˜„


&nbsp;

`UserResponseDto`

```java
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class UserResponseDto {
    private String email;

    public static UserResponseDto of(User user){
        return new UserResponseDto(user.getEmail());
    }
}
```

- `email`ì„ `UserResponseDto`ì— ì €ì¥í•œë‹¤.
- ì´ë©”ì¼ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬

&nbsp;

&nbsp;

# ğŸ“šÂ 2. ë¡œê·¸ì¸

### ğŸ“–Â A. Dto

**âœ”ï¸Â UserRequestDto**

```java
@Slf4j
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class UserRequestDto {

    private String email;
    private String password;

}
```

&nbsp;

### ğŸ“–Â B. Service(TokenService)

- **Spring Security Architecture**
    
   <img width="861" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-12-24 á„‹á…©á„’á…® 6 00 18" src="https://user-images.githubusercontent.com/72541544/209440108-615a9976-c9c6-4a30-9a5d-e84627a59e8c.png">

    
    1.Â **ì‚¬ìš©ìê°€Â ë¡œê·¸ì¸Â ì •ë³´ì™€Â í•¨ê»˜Â ì¸ì¦Â ìš”ì²­ì„Â í•œë‹¤.(HttpÂ Request)**
    
    2.Â Â **`AuthenticationFilter`ê°€ ìš”ì²­ì„ ê°€ë¡œì±„ê³ , ê°€ë¡œì±ˆ ì •ë³´ë¥¼ í†µí•´ `UsernamePasswordAuthenticationToken`ì˜ ì¸ì¦ìš© ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.**
    
    3.Â **`AuthenticationManager`ì˜Â êµ¬í˜„ì²´ì¸Â `ProviderManager`ì—ê²ŒÂ ìƒì„±í•œÂ `UsernamePasswordToken`Â ê°ì²´ë¥¼Â ì „ë‹¬í•œë‹¤.**
    
    4.Â **`AuthenticationManager`ëŠ”Â ë“±ë¡ëœÂ `AuthenticationProvider`(ë“¤)ì„Â ì¡°íšŒí•˜ì—¬Â ì¸ì¦ì„Â ìš”êµ¬í•œë‹¤.**
    
    5**.Â ì‹¤ì œÂ DBì—ì„œÂ ì‚¬ìš©ìÂ ì¸ì¦ì •ë³´ë¥¼Â ê°€ì ¸ì˜¤ëŠ”Â `UserDetailsService`ì—Â ì‚¬ìš©ìÂ ì •ë³´ë¥¼Â ë„˜ê²¨ì¤€ë‹¤.**
    
    6.Â **ë„˜ê²¨ë°›ì€Â ì‚¬ìš©ìÂ ì •ë³´ë¥¼Â í†µí•´Â DBì—ì„œÂ ì°¾ì€Â ì‚¬ìš©ìÂ ì •ë³´ì¸Â `UserDetails`Â ê°ì²´ë¥¼Â ë§Œë“ ë‹¤.**
    
    7.Â **`AuthenticationProvider`(ë“¤)ì€Â `UserDetails`ë¥¼Â ë„˜ê²¨ë°›ê³ Â ì‚¬ìš©ìÂ ì •ë³´ë¥¼Â ë¹„êµí•œë‹¤.**
    
    8.Â **ì¸ì¦ì´Â ì™„ë£Œë˜ë©´Â ê¶Œí•œÂ ë“±ì˜Â ì‚¬ìš©ìÂ ì •ë³´ë¥¼Â ë‹´ì€Â `Authentication`Â ê°ì²´ë¥¼Â ë°˜í™˜í•œë‹¤.**
    
    9.Â **ë‹¤ì‹œÂ ìµœì´ˆì˜Â `AuthenticationFilter`ì—Â `Authentication`Â ê°ì²´ê°€Â ë°˜í™˜ëœë‹¤.**
    
    10.Â **`Authentication`Â ê°ì²´ë¥¼Â `SecurityContext`ì—Â ì €ì¥í•œë‹¤.**
    
    â‡’ **ìµœì¢…ì ìœ¼ë¡œ `SecurityContextHolder`ëŠ” ì„¸ì…˜ ì˜ì—­ì— ìˆëŠ” `SecurityContext`ì— `Authentication` ê°ì²´ë¥¼ ì €ì¥í•œë‹¤.**
    
    â‡’ **ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•œë‹¤ëŠ” ê²ƒì€ `Spring Security`ê°€ ì „í†µì ì¸ ì„¸ì…˜-ì¿ í‚¤ ê¸°ë°˜ì˜ ì¸ì¦ ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.**
    

&nbsp;

```java
		@Transactional
    public TokenDto login(UserRequestDto userRequestDto){

        // UsernamePasswordAuthenticationToken í˜•íƒœë¡œ ë¦¬í„´, SecurityContext ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì ˆì°¨
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìˆëŠ” ê²ƒ ì‚¬ìš©
        // í˜„ì¬ ì…ë ¥ëœ ì•„ì´ë””, íŒ¨ìŠ¤ì›Œë“œë¥¼ í†µí•´ tokenì„ ë°œê¸‰ë°›ëŠ”ë‹¤.
        // UsernamePasswordAuthenticationToken
        // - ì²« ë²ˆì§¸ ìƒì„±ìëŠ” ì¸ì¦ ì „ì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ê³ 
        // - ë‘ ë²ˆì§¸ ìƒì„±ìëŠ” ì¸ì¦ì´ ì™„ë£Œëœ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
        UsernamePasswordAuthenticationToken authenticationToken = userRequestDto.authenticationToken();

        // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
        // authenticate ë©”ì„œë“œê°€ ì‹¤í–‰ì´ ë  ë•Œ CustomUserDetailsService ì—ì„œ ë§Œë“¤ì—ˆë˜ loadUserByUsername ë©”ì„œë“œê°€ ì‹¤í–‰ë¨
        // loadUserByUsername
        // Authentication : ì¸ì¦
        Authentication authentication = authenticationManagerBuilder.getObject().authenticate(authenticationToken);

        // ì¸ì¦ ì •ë³´ë¥¼ í†µí•´ JWT í† í°ì„ ìƒì„±í•œë‹¤.
        TokenDto tokenDto = jwtTokenProvider.generateTokenDto(authentication);

        // RefreshToken ì €ì¥
        RefreshToken refreshToken = RefreshToken.builder()
                .key(authentication.getName())
                .value(tokenDto.getRefreshToken())
                .build();

        refreshTokenRepository.save(refreshToken);

        // í† í° ë°œê¸‰
        return tokenDto;
    }
```

&nbsp;

**âœ”ï¸Â UsernamePasswordAuthenticationTokenì„ í˜¸ì¶œí•˜ë‹¤?**

```java
    // TokenService
		UsernamePasswordAuthenticationToken authenticationToken = userRequestDto.authenticationToken();

		// UserRequestDto
		public UsernamePasswordAuthenticationToken authenticationToken(){
        return new UsernamePasswordAuthenticationToken(email, password);
    }

```

- `UserRequestDto`ì— êµ¬í˜„ëœ `authenticationToken` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.
- `UsernamePasswordAuthenticationToken` ì˜ ìƒì„±ìë¥¼ í˜¸ì¶œí•˜ëŠ”ë°?


&nbsp;

**âœğŸ»Â UsernamePasswordAuthenticationTokenì„ ëœ¯ì–´ë³´ë©´**

```java
public abstract class AbstractAuthenticationToken implements Authentication, CredentialsContainer {
}
 
public class UsernamePasswordAuthenticationToken extends AbstractAuthenticationToken {
 
	private static final long serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;
 
	// ì£¼ë¡œ ì‚¬ìš©ìì˜ IDì— í•´ë‹¹
	private final Object principal;
 
	// ì£¼ë¡œ ì‚¬ìš©ìì˜ PWì— í•´ë‹¹
	private Object credentials;
 
	// ì¸ì¦ ì™„ë£Œ ì „ì˜ ê°ì²´ ìƒì„±
	public UsernamePasswordAuthenticationToken(Object principal, Object credentials) {
		super(null);
		this.principal = principal;
		this.credentials = credentials;
		setAuthenticated(false);
	}
 
	// ì¸ì¦ ì™„ë£Œ í›„ì˜ ê°ì²´ ìƒì„±
	public UsernamePasswordAuthenticationToken(Object principal, Object credentials,
			Collection<? extends GrantedAuthority> authorities) {
		super(authorities);
		this.principal = principal;
		this.credentials = credentials;
		super.setAuthenticated(true); // must use super, as we override
	}
}
```

- `ì²« ë²ˆì§¸ principal` : ì£¼ë¡œ ì‚¬ìš©ìì˜ IDì— í•´ë‹¹í•œë‹¤.
- `ë‘ ë²ˆì§¸ credentials` : ì£¼ë¡œ ì‚¬ìš©ìì˜ PWì— í•´ë‹¹í•œë‹¤.


&nbsp;

**âœ”ï¸Â Authentication, authenticationManagerBuilderì„ í˜¸ì¶œí•˜ë‹¤?**

```java

private final AuthenticationManagerBuilder authenticationManagerBuilder;

Authentication authentication = authenticationManagerBuilder.getObject().authenticate(authenticationToken);
```

&nbsp;

**âœğŸ»Â AuthenticationManagerBuilderì„ ëœ¯ì–´ë³´ë©´**

```java
public class AuthenticationManagerBuilder
		extends AbstractConfiguredSecurityBuilder<AuthenticationManager, AuthenticationManagerBuilder>
		implements ProviderManagerBuilder<AuthenticationManagerBuilder> {

//...

}
```



- `AuthenticationManagerBuilder`ì—ì„œÂ `AuthenticationManager`Â ë¥¼ êµ¬í˜„í•œÂ `ProviderManager`Â ìƒì„±í•œë‹¤.


&nbsp;

**âœğŸ»Â AuthenticationManagerì„ ëœ¯ì–´ë³´ë©´**

```java
public interface AuthenticationManager {
 
	Authentication authenticate(Authentication authentication) throws AuthenticationException;
 
}
```

- ì¸ì¦ì— ëŒ€í•œ ë¶€ë¶„ì€ `AuthenticationManager` ë¥¼ í†µí•´ì„œ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤.
- ì‹¤ì§ˆì ìœ¼ë¡œëŠ” `AuthenticationManager`ì— ë“±ë¡ëœ `AuthenticationProvider`ì— ì˜í•´ ì²˜ë¦¬ëœë‹¤.
- ì¸ì¦ì— ì„±ê³µí•˜ë©´ ë‘ë²ˆì§¸ ìƒì„±ìë¥¼ ì´ìš©í•´ ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ `SecurityContext`ì— ì €ì¥í•œë‹¤.(?)


&nbsp;

**âœğŸ»Â AuthenticationProviderì„ ëœ¯ì–´ë³´ë©´**

```java
public interface AuthenticationProvider {
 
	Authentication authenticate(Authentication authentication) throws AuthenticationException;
 
	boolean supports(Class<?> authentication);
 
}
```

- `AuthenticationProvider`ì—ì„œëŠ” ì‹¤ì œ ì¸ì¦ì— ëŒ€í•œ ë¶€ë¶„ì„ ì²˜ë¦¬í•œë‹¤.
- **ì¸ì¦ ì „ì˜ `Authentication` ê°ì²´ë¥¼ ë°›ì•„ì„œ ì¸ì¦ì´ ì™„ë£Œëœ ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤.**
- ìœ„ì™€ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ `Custom`í•œ `AuthenticationProvider`ë¥¼ ì‘ì„±í•˜ê³  `AuthenticationManager`ì— ë“±ë¡í•˜ë©´ ëœë‹¤.(?)

â‡’ ê²°êµ­, `authenticationManagerBuilder.getObject().authenticate(authenticationToken);` ë¥¼ í†µí•´ ì¸ì¦í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.

â‡’ `Authentication authentication` ì— ì €ì¥ëœë‹¤.


&nbsp;

**âœğŸ»Â Authenticationì„ ëœ¯ì–´ë³´ë©´**

```java
public interface Authentication extends Principal, Serializable {
	// í˜„ì¬ ì‚¬ìš©ìì˜ ê¶Œí•œ ëª©ë¡ì„ ê°€ì ¸ì˜´
	Collection<? extends GrantedAuthority> getAuthorities();
    
	// credentials(ì£¼ë¡œ ë¹„ë°€ë²ˆí˜¸)ì„ ê°€ì ¸ì˜´
	Object getCredentials();
    
	Object getDetails();
 
	// Principal ê°ì²´ë¥¼ ê°€ì ¸ì˜´
	Object getPrincipal();
 
	// ì¸ì¦ ì—¬ë¶€ë¥¼ ê°€ì ¸ì˜´
	boolean isAuthenticated();
    
	// ì¸ì¦ ì—¬ë¶€ë¥¼ ì„¤ì •í•¨
	void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
 
}
```

- **í˜„ì¬ ì ‘ê·¼í•˜ëŠ” ì£¼ì²´ì˜ ì •ë³´ì™€ ê¶Œí•œì„ ë‹´ëŠ” ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.**
- `**Authentication` ê°ì²´ëŠ” `SecurityContext`ì— ì €ì¥ëœë‹¤.**
- `**SecurityContextHolder`ë¥¼ í†µí•´ `SecurityContext`ì— ì ‘ê·¼í•˜ê³ , `SecurityContext`ë¥¼ í†µí•´ `Authentication`ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.**


&nbsp;

**âœ”ï¸Â JwtTokenProviderì€ ì–´ë–¤ ê²ƒì¼ê¹Œ?**Â 

```java
private final JwtTokenProvider jwtTokenProvider;

TokenDto tokenDto = jwtTokenProvider.generateTokenDto(authentication);
```


&nbsp;

**âœğŸ»Â JwtTokenProviderì„ ëœ¯ì–´ë³´ë©´**

```java
@Slf4j
@Component
public class JwtTokenProvider {

    // ì´ í´ë˜ìŠ¤ì—ì„œ
    // - ìœ ì € ì •ë³´ë¡œ JWT í† í°ì„ ë§Œë“¤ê±°ë‚˜ í† í°ì„ ë°”íƒ•ìœ¼ë¡œ ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    // - JWT í† í°ì— ê´€ë ¨ëœ ì•”í˜¸í™”, ë³µí˜¸í™”, ê²€ì¦ ë¡œì§ì€ ë‹¤ ì´ê³³ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.

    // bean ì§ì ‘ ìƒì„±
    private static final String AUTHORITIES_KEY = "auth";
    private static final String BEARER_TYPE = "Bearer";
    private static final long ACCESS_TOKEN_EXPIRE_TIME = 1000 * 60 * 30;            // 30ë¶„
    private static final long REFRESH_TOKEN_EXPIRE_TIME = 1000 * 60 * 60 * 24 * 7;  // 7ì¼

    private final Key key;

    // application.yml ì— ì •ì˜í•´ë†“ì€ jwt.secret ê°’ì„ ê°€ì ¸ì™€ì„œ JWT ë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©í•˜ëŠ” ì•”í˜¸í™” í‚¤ê°’ì„ ìƒì„±
    public JwtTokenProvider(@Value("${spring.jwt.secret}") String secretKey){
        byte[] keyBytes = Decoders.BASE64.decode(secretKey);
        this.key = Keys.hmacShaKeyFor(keyBytes);
    }

    // ìœ ì € ì •ë³´ë¥¼ ë„˜ê²¨ë°›ì•„ì„œ Access Token ê³¼ Refresh Tokenì„ ìƒì„±
    public TokenDto generateTokenDto(Authentication authentication){
        // ê¶Œí•œë“¤ì„ ê°€ì ¸ì˜¤ê¸°
        String authorities = authentication.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.joining(","));

        long now = (new Date()).getTime(); // í˜„ì¬ ì‹œê°„

        // Access Tokenì„ ìƒì„±í•œë‹¤.
        Date accessTokenExpiresIn = new Date(now + ACCESS_TOKEN_EXPIRE_TIME);
        String accessToken = Jwts.builder()
                .setSubject(authentication.getName())       // payload "sub": "name"
                .claim(AUTHORITIES_KEY, authorities)        // payload "auth": "ROLE_USER"
                .setExpiration(accessTokenExpiresIn)        // payload "exp": 1516239022 (ì˜ˆì‹œ)
                .signWith(key, SignatureAlgorithm.HS512)    // header "alg": "HS512"
                .compact();

        // Refresh Token ìƒì„±
        String refreshToken = Jwts.builder()
                .setExpiration(new Date(now + REFRESH_TOKEN_EXPIRE_TIME))
                .signWith(key, SignatureAlgorithm.HS512)
                .compact();

        return TokenDto.builder()
                .grantType(BEARER_TYPE)
                .accessToken(accessToken)
                .accessTokenExpiresIn(accessTokenExpiresIn.getTime()) // ë§Œë£Œì‹œê°„
                .refreshToken(refreshToken)
                .build();
    }
}
```

- ìƒì„±ìì—ì„œëŠ” ?
    - `application.yml`Â ì— ì •ì˜í•´ë†“ì€Â `jwt.secret`Â ê°’ì„ ê°€ì ¸ì™€ì„œ JWT ë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©í•˜ëŠ” ì•”í˜¸í™” í‚¤ê°’ì„ ìƒì„±í•œë‹¤.
- `generateTokenDto`ì—ì„œëŠ” ? JWT í† í°ì— ê´€ë ¨ëœ **ì•”í˜¸í™”**
    - ìœ ì € ì •ë³´ë¥¼ ë„˜ê²¨ë°›ì•„ì„œ **Access Token ê³¼ Refresh Token ì„ ìƒì„±í•œë‹¤.**
    - ë„˜ê²¨ë°›ì€ ìœ ì € ì •ë³´ì˜Â `authentication.getName()`Â ë©”ì†Œë“œê°€Â `username`Â ì„ ê°€ì ¸ì˜¨ë‹¤.
    - `username`Â ìœ¼ë¡œ user ID ë¥¼ ì €ì¥í–ˆê¸° ë•Œë¬¸ì— í•´ë‹¹ ê°’ì´ ì„¤ì •ëœë‹¤.
    - Access Token ì—ëŠ” ìœ ì €ì™€ ê¶Œí•œ ì •ë³´ë¥¼ ë‹´ê³  Refresh Token ì—ëŠ” ì•„ë¬´ ì •ë³´ë„ ë‹´ì§€ ì•ŠëŠ”ë‹¤.


&nbsp;

**âœğŸ»Â TokenDtoëŠ” ì–´ë–¤ ê²ƒì¼ê¹Œ?**

```java
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class TokenDto {

    private String grantType; // ê³ ê°
    private String accessToken;
    private String refreshToken;
    private Long accessTokenExpiresIn; // ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œê¸°ê°„
}
```

&nbsp;


**âœ”ï¸Â RefreshTokenì— ì €ì¥í•œë‹¤.**

```java
RefreshToken refreshToken = RefreshToken.builder()
                .key(authentication.getName())
                .value(tokenDto.getRefreshToken())
                .build();
```


&nbsp;

**âœğŸ»Â RefreshTokenì€ ë¬´ì—‡ì¼ê¹Œ?**

```java
@Getter
@NoArgsConstructor
@Table(name = "refresh_token")
@Entity
public class RefreshToken {

    @Id
    @Column(name = "rt_key")
    private String key;

    @Column(name = "rt_value")
    private String value;

    @Builder
    public RefreshToken(String key, String value){
        this.key = key;
        this.value = value;
    }

    public RefreshToken updateValue(String token){
        this.value = token;
        return this;
    }
}
```

- `key`ì—ëŠ” ì‚¬ìš©ì `email`
- `value`ì—ëŠ” ì‚¬ìš©ì `refreshToken`


&nbsp;

**âœ”ï¸Â ëìœ¼ë¡œ repository í˜¸ì¶œ ë° í† í° ë°œê¸‰**

```java
refreshTokenRepository.save(refreshToken);

// í† í° ë°œê¸‰
return tokenDto;
```


&nbsp;

&nbsp;

# ğŸ“šÂ 3. í† í° ì¬ë°œê¸‰

### ğŸ“–Â A. Dto

**âœ”ï¸Â TokenRequestDto**

```java
@Getter
@NoArgsConstructor
public class TokenRequestDto {
    private String accessToken;
    private String refreshToken;
}
```

&nbsp;


### ğŸ“–Â B. Controller

```java
		@PostMapping("/reissue")
    public ResponseEntity<?> reissue(@RequestBody TokenRequestDto tokenRequestDto){
        return ResponseEntity.ok(userTokenRelatedService.reissue(tokenRequestDto));
    }
```

&nbsp;

### ğŸ“–Â C. Service

```java
		@Transactional
    public TokenDto reissue(TokenRequestDto tokenRequestDto){
        // Refresh Token ê²€ì¦
        if(!jwtTokenProvider.validateToken(tokenRequestDto.getRefreshToken())){
            throw new RuntimeException("Refresh Tokenì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // Access Tokenì—ì„œ User ID ê°€ì ¸ì˜¤ê¸°
        Authentication authentication = jwtTokenProvider.getAuthentication(tokenRequestDto.getAccessToken());

        // ì €ì¥ì†Œì—ì„œ User IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ Refresh Token ê°’ ê°€ì ¸ì˜¤ê¸°
        RefreshToken refreshToken = refreshTokenRepository.findByKey(authentication.getName())
                .orElseThrow(() -> new RuntimeException("ë¡œê·¸ì•„ì›ƒ ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤."));

        // Refresh Token ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬
        if(!refreshToken.getValue().equals(tokenRequestDto.getRefreshToken())){
            throw new RuntimeException("í† í°ì˜ ìœ ì € ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // ìƒˆë¡œìš´ í† í° ìƒì„±
        TokenDto tokenDto = jwtTokenProvider.generateTokenDto(authentication);

        // ì €ì¥ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
        RefreshToken newRefreshToken = refreshToken.updateValue(tokenDto.getRefreshToken());
        refreshTokenRepository.save(newRefreshToken);

        // í† í° ë°œê¸‰
        return tokenDto;
    }
```


&nbsp;

**âœ”ï¸Â Refresh Token ê²€ì¦**

```java
private final JwtTokenProvider jwtTokenProvider;		

// Refresh Token ê²€ì¦
if(!jwtTokenProvider.validateToken(tokenRequestDto.getRefreshToken())){
		throw new RuntimeException("Refresh Tokenì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
}
```

&nbsp;

**âœğŸ»Â validateTokenì€ ë¬´ì—‡ì´ì§€?**

```java
		public boolean validateToken(String token){
        try{
            Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
            return true;
        }catch (io.jsonwebtoken.security.SecurityException | MalformedJwtException e){
            log.info("ì˜ëª»ëœ JWT ì„œëª…ì…ë‹ˆë‹¤.");
        }catch (ExpiredJwtException e){
            log.info("ë§Œë£Œëœ JWT í† í°ì…ë‹ˆë‹¤.");
        }catch (UnsupportedJwtException e){
            log.info("ì§€ì›ë˜ì§€ ì•ŠëŠ” JWT í† í°ì…ë‹ˆë‹¤.");
        }catch (IllegalArgumentException e){
            log.info("JWT í† í°ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        return false;
    }
```

- **í† í°ì„ ê²€ì¦í•˜ëŠ” ê³³ì´ë‹¤.**
- **`Jwts`Â ëª¨ë“ˆì´ ì•Œì•„ì„œ Exceptionì„ ë˜ì ¸ì¤€ë‹¤.**

&nbsp;


**âœ”ï¸Â Access Tokenì—ì„œ User ID ê°€ì ¸ì˜¤ê¸°**

```java
Authentication authentication = jwtTokenProvider.getAuthentication(tokenRequestDto.getAccessToken());
```


&nbsp;


**âœğŸ»Â getAuthenticationëŠ” ë¬´ì—‡ì¼ê¹Œ?**

```java
		public Authentication getAuthentication(String accessToken){
        // í† í° ë³µí˜¸í™”
        Claims claims = parseClaims(accessToken);

        if(claims.get(AUTHORITIES_KEY) == null){
            throw new RuntimeException("ê¶Œí•œ ì •ë³´ê°€ ì—†ëŠ” í† í°ì…ë‹ˆë‹¤.");
        }

        // í´ë ˆì„ì—ì„œ ê¶Œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        Collection<? extends GrantedAuthority> authorities
                = Arrays.stream(claims.get(AUTHORITIES_KEY).toString().split(","))
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());

        // UserDetails ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ Authentication ë¦¬í„´ (ê¶Œí•œ ì¸ì¦ ë¦¬í„´)
        UserDetails userDetails = new org.springframework.security.core.userdetails.User(
                claims.getSubject()
                , ""
                , authorities
        );

        return new UsernamePasswordAuthenticationToken(userDetails, "",authorities);
    }

		private Claims parseClaims(String accessToken){
        try{
            return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(accessToken).getBody();
        }catch(ExpiredJwtException e){
            return e.getClaims();
        }
    }
```

- JWT í† í°ì„ ë³µí˜¸í™”í•˜ì—¬ í† í°ì— ë“¤ì–´ ìˆëŠ” ì •ë³´ë¥¼ êº¼ë‚¸ë‹¤.
- Access Token ì—ë§Œ ìœ ì € ì •ë³´ë¥¼ ë‹´ê¸° ë•Œë¬¸ì— ëª…ì‹œì ìœ¼ë¡œÂ `accessToken`Â ì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ”ë‹¤.
- Refresh Token ì—ëŠ” ì•„ë¬´ëŸ° ì •ë³´ ì—†ì´ ë§Œë£Œì¼ìë§Œ ë‹´ì•˜ë‹¤.
- `UserDetails`Â ê°ì²´ë¥¼ ìƒìƒì„±í•´ì„œÂ `UsernamePasswordAuthenticationToken`Â í˜•íƒœë¡œ ë¦¬í„´í•˜ëŠ”ë°Â `SecurityContext`Â ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì ˆì°¨ë‹¤.
- ì‚¬ì‹¤ ì¢€ ë¶ˆí•„ìš”í•œ ì ˆì°¨ë¼ê³  ìƒê°ë˜ì§€ë§ŒÂ `SecurityContext`Â ê°€Â `Authentication`Â ê°ì²´ë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— ì–´ì©”ìˆ˜ ì—†ë‹¤.
- **`parseClaims`Â ë©”ì†Œë“œëŠ” ë§Œë£Œëœ í† í°ì´ì–´ë„ ì •ë³´ë¥¼ êº¼ë‚´ê¸° ìœ„í•´ì„œ ë”°ë¡œ ë¶„ë¦¬í–ˆë‹¤.**


&nbsp;


**âœğŸ»Â SimpleGrantedAuthorityëŠ” ë¬´ì—‡ì¼ê¹Œ?**

```java
package org.springframework.security.core.authority;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.SpringSecurityCoreVersion;
import org.springframework.util.Assert;

/**
 * Basic concrete implementation of a {@link GrantedAuthority}.
 *
 * <p>
 * Stores a {@code String} representation of an authority granted to the
 * {@link org.springframework.security.core.Authentication Authentication} object.
 *
 * @author Luke Taylor
 */
public final class SimpleGrantedAuthority implements GrantedAuthority {

	private static final long serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;

	private final String role;

	public SimpleGrantedAuthority(String role) {
		Assert.hasText(role, "A granted authority textual representation is required");
		this.role = role;
	}

	@Override
	public String getAuthority() {
		return this.role;
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj) {
			return true;
		}
		if (obj instanceof SimpleGrantedAuthority) {
			return this.role.equals(((SimpleGrantedAuthority) obj).role);
		}
		return false;
	}

	@Override
	public int hashCode() {
		return this.role.hashCode();
	}

	@Override
	public String toString() {
		return this.role;
	}

}
```

- https://www.apache.org/licenses/LICENSE-2.0
- `GrantedAuthority` : í˜„ì¬ ì‚¬ìš©ìê°€ ê°€ì§€ê³  ìˆëŠ” ê¶Œí•œ
- toString() : ì—­í•  ë°˜í™˜
- equals() : í˜„ì¬ ì‚¬ìš©ì ê¶Œí•œê³¼ ê°™ì€ì§€ íŒë‹¨í•œë‹¤.


&nbsp;

**âœ”ï¸Â ì €ì¥ì†Œì—ì„œ User IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ Refresh Token ê°’ ê°€ì ¸ì˜¤ê¸°**

```java
RefreshToken refreshToken = refreshTokenRepository.findByKey(authentication.getName())
                .orElseThrow(() -> new RuntimeException("ë¡œê·¸ì•„ì›ƒ ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤."));
```

- `findByKey`ëŠ” Repositoryì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.


&nbsp;

**âœ”ï¸Â Refresh Token ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬**

```java
if(!refreshToken.getValue().equals(tokenRequestDto.getRefreshToken())){
		throw new RuntimeException("í† í°ì˜ ìœ ì € ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
}
```

&nbsp;


**âœ”ï¸Â ìƒˆë¡œìš´ í† í° ìƒì„±**

```java
TokenDto tokenDto = jwtTokenProvider.generateTokenDto(authentication);
```


&nbsp;

**âœ”ï¸Â ì €ì¥ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸(í† í° ì €ì¥) ë° ë°œê¸‰**

```java
// ì €ì¥ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
RefreshToken newRefreshToken = refreshToken.updateValue(tokenDto.getRefreshToken());
refreshTokenRepository.save(newRefreshToken);

// í† í° ë°œê¸‰
return tokenDto;
```


&nbsp;

&nbsp;



----

**ì°¸ê³ ìë£Œ**

[Spring Securityì˜ êµ¬ì¡°(Architecture) ë° ì²˜ë¦¬ ê³¼ì • ì•Œì•„ë³´ê¸°](https://dev-coco.tistory.com/174)